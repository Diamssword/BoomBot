<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
	<% let totMessagerie = 0;
	if(locals.userInfos){
		
                for(k in userInfos.MESSAGES)
                {
                    totMessagerie =+userInfos.MESSAGES[k];
                }
			}%>
		
	var messagerieHeaderNotif=<%=totMessagerie%>;
    <% if (!locals.agencesDisableReload) {%>
        socket.on("general.agencePicked", (data) => {
            if (!data.error) {
                document.location.reload();
            }
        });
    <%}%>

	setInterval(checkMessages,128000)//128000 : 2 min
	function checkMessages()
	{
		socket.emit('general_notif.askRefresh',{})
	}
	socket.on("general_notif.sendRefresh", (data) => {
				if(data.msg !=messagerieHeaderNotif)
				{
					let span=document.getElementById('notif_messages_count');
					span.innerText=data.msg;
					if(data.msg >messagerieHeaderNotif) 
					{
						new Audio('assets/sounds/msg_notif.mp3').play();
						span.hidden=false;
					}
					else if(data.msg<=0)
						span.hidden=true;
					messagerieHeaderNotif = data.msg;
				}
				
        });
</script>

<header>
    <article class="left_header">
        <div class="logo_agence">
            <!-- background image -->
            <img class="bg_header" src="assets/svg/header.svg" alt="" />

            <!-- Logo -->
            <img class="logo_header" src="assets/logo/logo-drive-innov-blanc.png" alt=l />

            <!-- menu déroulant agence  -->
            <div class="div_choix_agence">
                <% if(locals.agences){ %>
                    <label for="agence">Agence : </label>
                    <select class="choix_agence" id="agence" name="agence" onchange="onSelectAgence()">
    
                        <% agences.forEach(el=>{ %>
                            <option value="<%= el %>" <%if(locals.selectedAgence===el) {%> selected<%}%>><%= el %>
                            </option>
                            <% }); %>
                                <% if(agences.length>1 && !locals.agencesAllDisabled){ %>
                                    <option value="Toute" <%if(locals.selectedAgence==='Toute' ) {%> selected<%}%> >Toute
                                    </option>
                                    <% } %>
                    </select>
    
                    <script>
                            function onSelectAgence() {
                                var el = document.getElementById("agence");
                                var obj = { agence: el.options[el.selectedIndex].text };
                                if (el.options[el.selectedIndex].text == "Toute")
                                    obj.pickall = true;
                                socket.emit('general.onPickAgence', obj);
                            }
                    </script>
                    <% } %>
            </div>
            <div id="crouton">
                <ul>
                    <%if(locals.breadcrumbs){
                        for(k in breadcrumbs){
                            let nd=breadcrumbs[k];%>
                    <li><a href="<%= nd.url%>"><%= nd.name%></a></li>
                    <%}}%>
                </ul>
            </div>
        </div>
            
    </article>
    <article class="right_header">
		<%
			var prenomuser="Anonyme";
			var nomuser="";		
			var countNotif="0";
			if(locals.userInfos)
			{
				prenomuser= userInfos.PRENOM;
				if((prenomuser+" "+ userInfos.NOM).length >15)
					nomuser= userInfos.NOM.substring(0,1)+".";
				else
					nomuser= userInfos.NOM;
				countNotif=userInfos.NOTIFS.length;
			}
			%>
        <div class="parametre_utilisateur">
			<a href="/logout" class="deconnexion">Déconnexion</a>
            <a href="/profil" class="profils"><%=prenomuser%> <%=nomuser%> </a>

            <%
			var prenomuser="Anonyme";
			var nomuser="";		
			var countNotif="0";
			if(locals.userInfos)
			{
				prenomuser= userInfos.PRENOM;
				if((prenomuser+" "+ userInfos.NOM).length >15)
					nomuser= userInfos.NOM.substring(0,1)+".";
				else
					nomuser= userInfos.NOM;
				countNotif=userInfos.NOTIFS.length;
			}
			%>
            <div class="div_notif">
			<a class="notification" href="/centre_notification">
                <svg viewbox="-10 0 35 35">
                    <path <%if(countNotif !== 0){%>class="notification--bell"<%}%> d="M14 12v1H0v-1l0.73-0.58c0.77-0.77 0.81-3.55 1.19-4.42 0.77-3.77 4.08-5 4.08-5 0-0.55 0.45-1 1-1s1 0.45 1 1c0 0 3.39 1.23 4.16 5 0.38 1.88 0.42 3.66 1.19 4.42l0.66 0.58z"></path> 
                    <path <%if(countNotif !== 0){%>class="notification--bellClapper"<%}%> d="M7 15.7c1.11 0 2-0.89 2-2H5c0 1.11 0.89 2 2 2z"></path>
                </svg>
                    <%if(countNotif !== 0){%>
                    <span class="notification--num"><%=countNotif%></span>
                    <%}%>
			</a>
			<a class="message" href="/messagerie_general" >
				<img src="assets/svg/message.svg" alt="logo messagerie"  onMouseover="src='assets/svg/message_ouvert.svg'" onMouseout="src='assets/svg/message.svg'">
	            <span id='notif_messages_count' class="notification--num"<%if(totMessagerie <= 0){%>hidden=true <%}%>><%=totMessagerie%>   </span>
                 
			</a>

		</div>
        </div>
        
        <div class="navigation">
            <%if(locals.accessLinks){%>
				<div id="menuHeaderAccueil">
					<img src="assets/svg/home.svg">
	
					<a>Accueil</a>
				</div>
				<%if(accessLinks.includes('GET:/planning')){%>
	
				<div id="menuHeaderPlanning">
					<img src="assets/svg/planning.svg">
	
					<a href="/planning">Planning</a>
				</div>
	
				<%}%>
				<%if(accessLinks.includes('GET:/eleves')){%>
					<div id="menuHeaderEleves">
						<img src="assets/svg/eleve.svg">
						<a href="/eleves">Élèves</a>
					</div>
				<%}%>
				<%if(accessLinks.includes('GET:/pros')){%>
					<div id="menuHeaderPros">
						<img src="assets/svg/stage.svg">
						<a href="/pros">Professionnels</a>
					</div>
				<%}%>
				<%if(accessLinks.includes('GET:/examens')){%>
					<div id="menuHeaderExamens">
						<img src="assets/svg/examens.svg">
						<a href="/examens">Examens</a>
					</div>
				<%}%>
				<%if(accessLinks.includes('GET:/analyse')){%>
					<div id="menuHeaderAnalyse">
						<img src="assets/svg/analyse.svg">
						<a href="/analyse">Analyses</a>
					</div>
				<%}%>
				<%if(accessLinks.includes('GET:/tresorie')){%>
					<div id="menuHeaderTresorie">
						<img src="assets/svg/tresorie.svg">
						<a href="/tresorie">Trésorie</a>
					</div>
				<%}%>
				<%if(accessLinks.includes('GET:/code_route')){%>
					<div id="menuHeaderCoderoute">
						<img src="assets/svg/code_route.svg">
						<a href="/cdr_crea_theme">Code de la route</a>
					</div>
				<%}%>
				<%if(accessLinks.includes('GET:/liste_agences')){%>
					<div id="menuHeaderParametres">
						<img src="assets/svg/parametre.svg">
						<a href="/parametres">Paramètres</a>
					</div>
				<%}%>
	
			<%}%>
	
		
        </div>
    </article>
</header>



<script>
	<% if(locals.baseHeader){ %>
		document.getElementById("menuHeader<%= locals.baseHeader %>").style.opacity = "1"; 

	<%}%>

</script>